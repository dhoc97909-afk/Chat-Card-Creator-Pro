<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Card Creator Pro | ×¤×•×ª×— ×¢"×™ ×“×•×“</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js"></script>
  <style>
    /* Basic styling and font import */
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;700;800&display=swap');
    body {
      font-family: 'Heebo', sans-serif;
      direction: rtl;
      background-color: #f7f9fc; /* Super light, professional background */
      color: #1f2937;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Main App Layout (3-Column Grid) */
    .app-container {
      display: grid;
      grid-template-columns: 1fr; /* Default to single column for mobile */
      gap: 20px;
      padding: 20px;
      flex-grow: 1;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }
    @media (min-width: 1200px) {
      .app-container {
        /* Left Sidebar (250px), Center Card (Max 700px), Right Sidebar (350px) */
        grid-template-columns: 250px minmax(0, 1fr) 350px; 
        gap: 40px;
        padding: 40px;
      }
    }
    
    /* Global Card Style - Elevated and clean */
    .app-card {
      background: white;
      border: 1px solid #e2e8f0;
      box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    /* Sidebar Styling (Left & Right) */
    .sidebar {
      position: sticky;
      top: 20px;
      height: fit-content;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }
    
    /* Header Styling */
    .app-header {
      background-color: #1f2937; /* Darker header for premium feel */
      color: white;
      border-bottom: 1px solid #374151;
      box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.2);
      padding: 16px 32px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .app-header h1 {
        font-size: 1.8rem;
        font-weight: 800;
        color: white;
    }

    /* Input Styling - Minimalist and high contrast */
    input[type="text"], input[type="number"], input[type="datetime-local"], select {
      font-size: 15px;
      padding: 10px 14px; 
      border-radius: 6px;
      background-color: #f1f5f9; /* Light gray input background */
      color: #1f2937;
      border: 1px solid #cbd5e1;
      width: 100%;
      box-sizing: border-box;
      text-align: right;
    }
    input:focus, select:focus {
        border-color: #3b82f6; 
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        background-color: white;
        outline: none;
    }

    /* Button Styling */
    .btn {
      font-size: 15px;
      padding: 12px 16px; 
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background-color: #10b981; /* Green accent for main actions (Send) */
      color: white;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
    }
    .btn-primary:hover {
      background-color: #059669;
      transform: translateY(-1px);
    }
    .btn-secondary {
        background-color: #f1f5f9; 
        color: #374151;
        border: 1px solid #e2e8f0;
    }
    .btn-secondary:hover {
        background-color: #e2e8f0;
    }

    /* Center Column - Preview Card as Editor */
    .preview-editor-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 10px;
    }
    .preview-card {
      width: 100%;
      max-width: 500px; /* Constrain card width for mobile look */
      background-color: #e3f2fd; 
      border: 1px solid #bbdefb;
      border-radius: 12px;
      padding: 16px;
      color: #1f2937;
      text-align: right;
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      min-height: 400px;
    }
    .preview-card.gradient-bg {
        background: linear-gradient(135deg, #a7bfe8, #619aed);
        color: #1e293b;
    }

    /* Inline Editable Elements Styling */
    .editable-title, .editable-subtitle, .rich-editor-content {
        padding: 5px;
        margin: -5px;
        border-radius: 4px;
        transition: background-color 0.2s;
        border: 1px solid transparent;
        outline: none; /* Hide default outline */
        cursor: text;
        min-height: 1.5em; /* Ensure clicking is easy */
    }
    .editable-title:focus, .editable-subtitle:focus, .rich-editor-content:focus {
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px solid #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .editable-subtitle {
        font-size: 0.85em;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 5px;
        text-align: right;
        display: block;
    }
    .editable-title {
        font-size: 1.6rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: #1f2937;
    }
    .rich-editor-content {
        font-size: 0.95em;
        text-align: right;
        min-height: 150px;
        margin-top: 10px;
        padding: 10px;
        line-height: 1.6;
    }

    /* Floating/Contextual Toolbar */
    #floatingToolbar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #1f2937;
        border-radius: 12px;
        padding: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 90;
        display: none; /* Initially hidden */
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    #floatingToolbar.active {
        display: flex;
        opacity: 1;
    }
    #floatingToolbar button {
        background: none;
        border: none;
        color: white;
        padding: 8px 12px;
        margin: 0 2px;
        border-radius: 6px;
        transition: background-color 0.2s;
    }
    #floatingToolbar button:hover {
        background-color: #374151;
    }
    #floatingToolbar .color-picker-wrapper input[type="color"] {
        width: 30px;
        height: 30px;
        background-color: #374151;
    }

    /* Right Panel specific styling */
    .settings-group {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    .settings-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    /* Webhook List Styling */
    .webhook-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f1f5f9;
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 6px;
        border: 1px solid #e2e8f0;
    }

    /* Hide the ugly accordion for a cleaner look, use <details> instead */
    details summary {
        list-style: none;
    }
    details summary::-webkit-details-marker {
        display: none;
    }
  </style>
</head>
<body>
  
  <header class="app-header">
    <h1 class="flex items-center justify-center gap-3">
        <i class="fas fa-magic text-green-400 text-2xl"></i>
        Chat Card Creator Pro <span class="text-sm font-light text-gray-400">| ×¤×•×ª×— ×¢"×™ ×“×•×“</span>
    </h1>
  </header>

  <div class="app-container">
    
    <div class="actions-sidebar sidebar hidden lg:block">
        <div class="app-card flex flex-col gap-4">
            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-bolt text-green-500"></i>
                ×¤×¢×•×œ×•×ª ×¨××©×™×•×ª
            </h2>
            <button type="button" onclick="sendCard()" class="btn btn-primary w-full">
              <i class="fas fa-paper-plane"></i>
              ×©×œ×— ×”×•×“×¢×” ×›×¢×ª
            </button>
            <button type="button" onclick="copyCardData()" class="btn btn-secondary w-full">
              <i class="fas fa-clipboard"></i>
              ×”×¢×ª×§ × ×ª×•× ×™ ×›×¨×˜×™×¡
            </button>
            
            <details class="mt-4">
                <summary class="font-bold cursor-pointer text-gray-700 py-2 flex justify-between items-center border-t pt-4">
                    <span class="flex items-center gap-2"><i class="fas fa-globe text-blue-500"></i> × ×™×”×•×œ Webhooks</span>
                    <i class="fas fa-chevron-down text-xs"></i>
                </summary>
                <div class="p-2 bg-white rounded-b-lg">
                    <h4 class="font-bold text-base text-gray-700 mb-2 mt-2">×‘×—×¨ ×¢×¨×•×¦×™×:</h4>
                    <div id="webhookOptions" class="bg-gray-50 p-2 rounded-lg border border-gray-200 max-h-32 overflow-y-auto mb-3"></div>
                    
                    <h4 class="font-bold text-base text-gray-700 mb-2">×”×•×¡×£ ×—×“×©:</h4>
                    <div class="flex flex-col gap-2">
                        <input type="text" id="newWebhookName" placeholder="×©× Webhook" />
                        <input type="text" id="newWebhookUrl" placeholder="×›×ª×•×‘×ª Webhook" />
                        <button type="button" onclick="addWebhook()" class="btn btn-primary text-sm bg-blue-500 hover:bg-blue-600">
                          <i class="fas fa-plus"></i>
                          ×”×•×¡×£
                        </button>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <div class="center-editor-column">
        <div class="preview-editor-wrapper">
            <div class="preview-card" onfocusout="handleCardFocusOut(event)">
                <input type="text" id="headerImageUrl" placeholder="URL ×©×œ ×ª××•× ×” ×œ×›×•×ª×¨×ª (××•×¤×¦×™×•× ×œ×™)" class="w-full text-center mb-3 text-sm focus:border-blue-500 focus:shadow-md" oninput="updatePreview()" />
                <img id="previewHeaderImage" alt="×ª××•× ×” ×‘×›×•×ª×¨×ª" class="hidden max-w-full rounded-t-lg mb-4" />
                
                <span class="editable-subtitle" id="previewSenderName" contenteditable="true" data-placeholder="×©× ×”×©×•×œ×— (××•×¤×¦×™×•× ×œ×™)" oninput="updateExternalInput(this, 'senderNameInput')">×”×•×“×¢×” ×—×“×©×”</span>
                <div class="editable-title" id="previewTitle" contenteditable="true" data-placeholder="×›×•×ª×¨×ª ×”×›×¨×˜×™×¡ (×—×•×‘×”)" oninput="updateExternalInput(this, 'cardTitleInput')">×›×•×ª×¨×ª ×”×”×•×“×¢×” ×”××¨×›×–×™×ª</div>
                
                <div id="richEditor" contenteditable="true" class="rich-editor-content" aria-label="×ª×•×›×Ÿ ×”×”×•×“×¢×”" data-placeholder="ğŸ‘‹ ×× × ×”×›× ×¡ ×›××Ÿ ××ª ×ª×•×›×Ÿ ×”×”×•×“×¢×”. × ×¡×” ×œ×¢×¦×‘ ×˜×§×¡×˜×™× ×©×•× ×™×." onfocus="handleEditorFocus(true)" oninput="updatePreview()">
                  ğŸ‘‹ ×× × ×”×›× ×¡ ×›××Ÿ ××ª ×ª×•×›×Ÿ ×”×”×•×“×¢×”. × ×¡×” ×œ×¢×¦×‘ ×˜×§×¡×˜×™× ×©×•× ×™×.
                </div>
                
                <img id="previewImage" alt="×ª××•× ×” ×‘×›×¨×˜×™×¡" class="hidden max-w-full rounded-lg mt-4 shadow-md" />
                
                <div id="previewButton" class="text-center mt-4"></div>
            </div>
        </div>

        <div id="floatingToolbar" class="flex flex-wrap gap-2">
            <button type="button" onclick="execCmd('bold')" title="××•×“×’×©" class="font-bold">B</button>
            <button type="button" onclick="execCmd('italic')" title="× ×˜×•×™" class="italic">I</button>
            <button type="button" onclick="execCmd('underline')" title="×§×• ×ª×—×ª×•×Ÿ" class="underline">U</button>
            <button type="button" onclick="execCmd('insertUnorderedList')" title="×¨×©×™××”">
              <i class="fas fa-list-ul"></i>
            </button>
            <button type="button" onclick="execCmd('justifyRight')" title="×™×™×©×•×¨ ×œ×™××™×Ÿ">
              <i class="fas fa-align-right"></i>
            </button>
            <button type="button" onclick="insertLinkPrompt()" title="×”×˜××¢×ª ×§×™×©×•×¨">
              <i class="fas fa-link"></i>
            </button>
             <button type="button" onclick="applySmartColorsAndFormattingWithAI()" title="×¦×‘×¢×™ AI" class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white">
                <span id="aiButtonText"><i class="fas fa-magic"></i> AI</span>
                <span id="aiSpinner" class="spinner hidden"></span>
             </button>
            <div class="color-picker-wrapper">
                 <input type="color" id="fontColor" value="#1f2937" onchange="execCmd('foreColor', this.value)" title="×‘×—×¨ ×¦×‘×¢ ×˜×§×¡×˜" />
            </div>
        </div>
    </div>

    <div class="settings-sidebar sidebar">
        <div class="app-card">
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                <i class="fas fa-cog text-blue-500"></i>
                ×”×’×“×¨×•×ª ××ª×§×“××•×ª
            </h2>
            
            <div class="settings-group">
                <h3 class="font-bold text-gray-700 mb-2 flex items-center gap-2"><i class="fas fa-image text-blue-400"></i> ×ª××•× ×” ×•×›×¤×ª×•×¨×™×</h3>
                <input type="text" id="imageUrl" placeholder="URL ×©×œ ×ª××•× ×” ×‘×ª×•×š ×”×›×¨×˜×™×¡" oninput="updatePreview()" class="mb-2" />
                <input type="text" id="buttonText" placeholder="×˜×§×¡×˜ ×¢×œ ×”×›×¤×ª×•×¨" oninput="updatePreview()" class="mb-2" />
                <input type="text" id="buttonUrl" placeholder="×›×ª×•×‘×ª ×§×™×©×•×¨ ×œ×›×¤×ª×•×¨" oninput="updatePreview()" />
            </div>

            <div class="settings-group">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-clock text-blue-400"></i> ×ª×–××•×Ÿ ×©×œ×™×—×”</h3>
                
                <h4 class="text-sm font-semibold text-gray-600 mb-1">×©×œ×™×—×” ×—×“ ×¤×¢××™×ª:</h4>
                <input type="datetime-local" id="scheduledDateTime" class="w-full mb-2" />
                <button type="button" onclick="scheduleSendAtDateTime()" class="btn btn-secondary w-full text-sm mb-4">
                  <i class="fas fa-calendar-alt"></i>
                  ×ª×–××Ÿ ×œ×©×¢×” ×–×•
                </button>
                
                <h4 class="text-sm font-semibold text-gray-600 mb-1">×©×œ×™×—×” ×—×•×–×¨×ª:</h4>
                <div class="flex w-full gap-2 mb-2">
                    <input type="number" id="intervalAmount" placeholder="××¡×¤×¨" min="1" class="w-1/3" />
                    <select id="intervalUnit" aria-label="×™×—×™×“×ª ×–××Ÿ ×œ×©×œ×™×—×”" class="w-2/3">
                      <option value="minutes">×“×§×•×ª</option>
                      <option value="hours">×©×¢×•×ª</option>
                      <option value="days">×™××™×</option>
                    </select>
                </div>
                <div class="flex w-full gap-2">
                    <button type="button" onclick="startCustomAutoSend()" class="btn flex-1 bg-green-500 hover:bg-green-600 text-white text-sm">
                      <i class="fas fa-play"></i>
                      ×”×¤×¢×œ ××•×˜×•××˜×™
                    </button>
                    <button type="button" onclick="stopCustomAutoSend()" class="btn flex-1 bg-red-500 hover:bg-red-600 text-white text-sm">
                      <i class="fas fa-stop"></i>
                      ×¢×¦×•×¨
                    </button>
                </div>
            </div>

            <div class="settings-group">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-palette text-blue-400"></i> ×¢×™×¦×•×‘ ×ª×¦×•×’×”</h3>
                <button type="button" onclick="toggleGradient()" class="btn btn-secondary w-full mb-3 text-sm">
                  <i class="fas fa-star-of-life"></i>
                  ×”×—×œ ×¨×§×¢ ×’×¨×“×™×× ×˜
                </button>
                <div class="color-picker-wrapper justify-between">
                    <label for="previewBgColor" class="text-sm font-semibold text-gray-700">×¦×‘×¢ ×¨×§×¢ ×›×¨×˜×™×¡:</label>
                    <input type="color" id="previewBgColor" value="#e3f2fd" onchange="changePreviewBg(this.value)" title="×‘×—×¨ ×¦×‘×¢ ×¨×§×¢" />
                </div>
            </div>
            
        </div>
        
        <div id="statusBox" aria-live="polite" class="text-gray-600 font-bold mt-4 min-h-[20px] text-center p-2 rounded-lg bg-yellow-100 border border-yellow-300">×¡×˜×˜×•×¡: ×××ª×™×Ÿ ×œ×¤×¢×•×œ×”.</div>
    </div>
  </div>

  <div id="messageBox" class="fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-xl text-center z-[100] transition-opacity duration-300 opacity-0"></div>
  
  <footer class="app-footer">
    </footer>

<script>
    /* ======= GLOBAL VARIABLES & STATE (Simulated) ======= */
    let autoSendIntervalId = null;
    let scheduledTimeoutId = null;
    let webhooks = [];
    
    // External "Virtual" Inputs (used by the logic for consistency)
    // These hold the values of the inline contenteditable fields.
    const virtualInputs = {
        cardTitleInput: "×›×•×ª×¨×ª ×”×”×•×“×¢×” ×”××¨×›×–×™×ª",
        senderNameInput: "×”×•×“×¢×” ×—×“×©×”",
        headerImageUrlInput: "",
        imageUrlInput: "",
        buttonTextInput: "",
        buttonUrlInput: "",
    };

    // DOM elements
    const richEditor = document.getElementById('richEditor');
    const previewHeaderImage = document.getElementById('previewHeaderImage');
    const previewSenderName = document.getElementById('previewSenderName');
    const previewTitle = document.getElementById('previewTitle');
    const previewImage = document.getElementById('previewImage');
    const previewButton = document.getElementById('previewButton');
    const statusBox = document.getElementById('statusBox');
    const webhookOptions = document.getElementById('webhookOptions');
    const previewCard = document.querySelector('.preview-card');
    const floatingToolbar = document.getElementById('floatingToolbar');
    const aiButtonText = document.getElementById('aiButtonText');
    const aiSpinner = document.getElementById('aiSpinner');
    const headerImageUrlInput = document.getElementById('headerImageUrl');
    const buttonTextInput = document.getElementById('buttonText');
    const buttonUrlInput = document.getElementById('buttonUrl');
    const imageUrlInput = document.getElementById('imageUrl');


    /* ======= UI INTERACTION FUNCTIONS ======= */
    
    /**
     * Updates the global virtual input state based on the inline editor's content.
     */
    window.updateExternalInput = function(element, inputName) {
        virtualInputs[inputName] = element.textContent.trim();
        updatePreview(); // Trigger full preview update
    }

    /**
     * Handles focus for the main rich editor to show the contextual toolbar.
     */
    window.handleEditorFocus = function(isFocused) {
        if (isFocused) {
            floatingToolbar.classList.add('active');
        }
    }
    
    /**
     * Handles focus out for the entire card to hide the toolbar if necessary.
     */
    window.handleCardFocusOut = function(event) {
        // Check if the focus target is outside the rich editor and outside the toolbar
        if (!richEditor.contains(event.relatedTarget) && !floatingToolbar.contains(event.relatedTarget)) {
            setTimeout(() => { // Small delay for toolbar button clicks to register
                if (document.activeElement !== richEditor && !floatingToolbar.contains(document.activeElement)) {
                     floatingToolbar.classList.remove('active');
                }
            }, 150);
        }
    }
    
    /**
     * Displays a message to the user in a floating box.
     */
    function displayMessage(text, type = 'info') {
        const msgBox = document.getElementById('messageBox');
        msgBox.textContent = text;
        
        msgBox.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-xl text-center z-[100] transition-opacity duration-300 show';
        
        switch (type) {
            case 'error':
                msgBox.classList.add('bg-error');
                break;
            case 'success':
                msgBox.classList.add('bg-success');
                break;
            default:
                msgBox.classList.add('bg-info');
                break;
        }

        setTimeout(() => { msgBox.classList.remove('show'); }, 4000);
    }

    /**
     * Rich Text Command Execution
     */
    window.execCmd = function(command, value = null) {
        // Ensure the editor is focused before executing command (for non-rich text commands)
        if (command !== 'foreColor') richEditor.focus();
        document.execCommand(command, false, value);
        updatePreview();
        // Keep focus on editor after command if it was focused initially
        if (document.activeElement !== floatingToolbar) richEditor.focus(); 
    }

    window.insertLinkPrompt = function() {
        richEditor.focus();
        const selection = document.getSelection();
        const selectedText = selection.toString();
        const url = prompt(`×”×›× ×¡ ×›×ª×•×‘×ª ×§×™×©×•×¨ ×¢×‘×•×¨: "${selectedText}" (×›×•×œ×œ https://):`);
        if (!url) return;
        execCmd('createLink', url);
    }
    
    window.toggleGradient = function() {
        previewCard.classList.toggle('gradient-bg');
    }

    window.changePreviewBg = function(color) {
        previewCard.style.backgroundColor = color;
    }
    
    window.applySmartColorsAndFormattingWithAI = async function() {
        const text = richEditor.innerText;
        if (text.trim() === '') {
            displayMessage('××™×Ÿ ×˜×§×¡×˜ ×œ× ×ª×—.', 'info');
            return;
        }
      
        aiButtonText.classList.add('hidden');
        aiSpinner.classList.remove('hidden');
        
        // --- SIMULATED AI RESPONSE (for demo/testing only) ---
        const simulatedResponse = [
            {"text": "Chat Card Creator Pro", "color": "#10b981", "emoji": "âœ…", "bold": true}, 
            {"text": "×”×•×“×¢×”", "color": "#3b82f6", "emoji": "ğŸŒ", "italic": true}
        ];

        try {
            await new Promise(resolve => setTimeout(resolve, 800));

            const parsedJson = simulatedResponse; 

            let newHtml = richEditor.innerHTML;
            parsedJson.forEach(item => {
                const textToReplace = item.text;
                const color = item.color || '#1f2937'; 
                const emoji = item.emoji || '';
                const bold = item.bold || false;
                const italic = item.italic || false;
            
                const escapedText = textToReplace.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(?![^<]*>)${escapedText}(?![^<]*>)`, 'g');
            
                let formattedText = `<font color="${color}">${textToReplace}</font>`;
                if (bold) formattedText = `<b>${formattedText}</b>`;
                if (italic) formattedText = `<i>${formattedText}</i>`;

                formattedText = `${emoji} ${formattedText}`;

                newHtml = newHtml.replace(regex, formattedText);
            });
            richEditor.innerHTML = newHtml;
            updatePreview();
            displayMessage('×¦×‘×¢×™× ×•×¢×™×¦×•×‘×™× ×”×•×—×œ×•!', 'success');
        
        } catch (error) {
            console.error('Error in AI function:', error);
            displayMessage('×©×’×™××” ×‘×ª×”×œ×™×š ×”×¢×™×‘×•×“ ×”××•×˜×•××˜×™.', 'error');
        } finally {
            aiButtonText.classList.remove('hidden');
            aiSpinner.classList.add('hidden');
        }
    }


    /* ======= LocalStorage Functions for Webhooks ======= */
    function saveWebhooksToLocalStorage() {
        localStorage.setItem('webhooks', JSON.stringify(webhooks));
    }

    function loadWebhooksFromLocalStorage() {
        const storedWebhooks = localStorage.getItem('webhooks');
        if (storedWebhooks) {
            webhooks = JSON.parse(storedWebhooks);
        } else {
            webhooks = [];
        }
        renderWebhookOptions();
    }

    window.addWebhook = function() {
        const name = document.getElementById('newWebhookName').value.trim();
        const url = document.getElementById('newWebhookUrl').value.trim();
        if (name && url) {
            const newWebhook = { id: Date.now().toString(), name, url, selected: false };
            webhooks.push(newWebhook);
            saveWebhooksToLocalStorage();
            document.getElementById('newWebhookName').value = '';
            document.getElementById('newWebhookUrl').value = '';
            displayMessage('Webhook × ×•×¡×£.', 'success');
            renderWebhookOptions();
        } else {
            displayMessage('×× × ××œ× ××ª ×©× ×™ ×”×©×“×•×ª.', 'error');
        }
    }

    window.removeWebhook = function(id) {
        webhooks = webhooks.filter(w => w.id !== id);
        saveWebhooksToLocalStorage();
        displayMessage('Webhook ×”×•×¡×¨.', 'info');
        renderWebhookOptions();
    }

    window.toggleWebhookSelection = function(id) {
        const webhook = webhooks.find(w => w.id === id);
        if (webhook) {
            webhook.selected = !webhook.selected;
            saveWebhooksToLocalStorage();
        }
    }

    /* ======= Rendering UI from Data ======= */
    function renderWebhookOptions() {
        webhookOptions.innerHTML = '';
        if (webhooks.length === 0) {
            webhookOptions.innerHTML = '<p class="text-xs text-gray-500 text-center py-2">××™×Ÿ Webhooks ×©××•×¨×™× ×œ×‘×—×™×¨×”.</p>';
            return;
        }
        webhooks.forEach(w => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center mb-1 bg-gray-100 p-2 rounded-md text-sm';
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="webhook-opt-${w.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${w.selected ? 'checked' : ''} onchange="toggleWebhookSelection('${w.id}')">
                    <label for="webhook-opt-${w.id}" class="flex-grow cursor-pointer text-gray-700">${w.name}</label>
                </div>
                <button type="button" class="text-red-500 hover:text-red-700 text-xs p-1 rounded-full" onclick="removeWebhook('${w.id}')" title="××—×§">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            webhookOptions.appendChild(div);
        });
    }

    /* ======= Core Payload & Sending Logic ======= */
    function getPayloadForGoogleChat() {
        const headerImageUrl = headerImageUrlInput.value.trim();
        const senderName = previewSenderName.textContent.trim();
        const title = previewTitle.textContent.trim();
        const messageContentHtml = richEditor.innerHTML;
        const imageUrl = imageUrlInput.value.trim();
        const buttonText = buttonTextInput.value.trim();
        const buttonUrl = buttonUrlInput.value.trim();
        
        if (!title) {
            throw new Error('Missing card title.');
        }

        // --- HTML to Google Chat Formatting Conversion ---
        let formattedMessage = messageContentHtml
            .replace(/<br>/g, '\n')
            .replace(/<p>([\s\S]*?)<\/p>/g, '$1\n')
            .replace(/<font color="([^"]+)">(.*?)<\/font>/g, '<font color="$1">$2</font>')
            .replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')
            .replace(/<i>(.*?)<\/i>/g, '<i>$1</i>')
            .replace(/<u>(.*?)<\/u>/g, '<u>$1</u>')
            .replace(/<ul>([\s\S]*?)<\/ul>/g, (match, p1) => {
                const items = p1.match(/<li>(.*?)<\/li>/g);
                return items ? items.map(item => `\n â€¢ ${item.replace(/<li>|<\/li>/g, '').trim()}`).join('') : '';
            })
            .replace(/<ol>([\s\S]*?)<\/ol>/g, (match, p1) => {
                const items = p1.match(/<li>(.*?)<\/li>/g);
                return items ? items.map((item, index) => `\n ${index + 1}. ${item.replace(/<li>|<\/li>/g, '').trim()}`).join('') : '';
            });
            
        formattedMessage = formattedMessage.replace(/(\n\s*){3,}/g, '\n\n').trim();

        const cardWidgets = [];
        
        if (formattedMessage.trim()) {
            cardWidgets.push({ "textParagraph": { "text": formattedMessage.trim() } });
        }
        
        if (imageUrl) {
            cardWidgets.push({ "image": { "imageUrl": imageUrl } });
        }

        if (buttonText && buttonUrl) {
            cardWidgets.push({
                "buttonList": {
                    "buttons": [{ "text": buttonText, "onClick": { "openLink": { "url": buttonUrl } } }]
                }
            });
        }
        
        const payload = {
            "cardsV2": [{
                "cardId": "unique-card-id",
                "card": {
                    "header": { 
                        "title": title, 
                        "subtitle": senderName, 
                        ...(headerImageUrl && { "imageUrl": headerImageUrl, "imageType": "SQUARE" })
                    },
                    "sections": [{ "widgets": cardWidgets.length > 0 ? cardWidgets : [{ "textParagraph": { "text": "(×”×•×“×¢×” ×œ×œ× ×ª×•×›×Ÿ ×’×•×£)" } }] }]
                }
            }]
        };

        return payload;
    }
    
    window.sendCard = async function() {
        const selectedWebhooks = webhooks.filter(w => w.selected);
        if (selectedWebhooks.length === 0) {
            displayMessage('×× × ×‘×—×¨ Webhook ××—×“ ×œ×¤×—×•×ª.', 'error');
            return;
        }
        
        let allSent = true;
        let googleChatPayload;
        
        try {
            googleChatPayload = getPayloadForGoogleChat();
        } catch (e) {
            displayMessage('×©×’×™××”: ×—×¡×¨×” ×›×•×ª×¨×ª ×›×¨×˜×™×¡.', 'error');
            return;
        }

        for (const webhook of selectedWebhooks) {
            let payload;
            
            if (webhook.url.includes('chat.googleapis.com')) {
                payload = googleChatPayload;
            } else {
                // Generic payload for other services (Slack/Discord etc.)
                let genericMessage = '';
                if (previewSenderName.textContent) genericMessage += `*× ×©×œ×— ×¢×œ ×™×“×™:* ${previewSenderName.textContent}\n`;
                if (previewTitle.textContent) genericMessage += `*${previewTitle.textContent}*\n\n`;
                genericMessage += `${richEditor.innerText.trim()}\n\n`; 
                if (buttonTextInput.value && buttonUrlInput.value) genericMessage += `[${buttonTextInput.value}](${buttonUrlInput.value})\n\n`;
                if (imageUrlInput.value) genericMessage += `×ª××•× ×”: ${imageUrlInput.value}`;
                
                payload = { "text": genericMessage.trim() || "×”×•×“×¢×” ×¨×™×§×”" };
            }

            try {
                const response = await fetch(webhook.url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.status < 200 || response.status >= 300) {
                    throw new Error(`HTTP error! status: ${response.status} - ${await response.text()}`);
                }
            } catch (error) {
                console.error(`Error sending message to webhook ${webhook.name}:`, error);
                allSent = false;
            }
        }
        
        if (allSent) {
            displayMessage(`×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ-${selectedWebhooks.length} Webhooks.`, 'success');
            statusBox.textContent = '× ×©×œ×— ×‘×”×¦×œ×—×”!';
        } else {
            displayMessage('×©×’×™××” ×‘×©×œ×™×—×” ×œ××—×“ ××• ×™×•×ª×¨ ××”-Webhooks.', 'error');
            statusBox.textContent = '×©×’×™××ª ×©×œ×™×—×”.';
        }
    }

    window.copyCardData = function() {
        try {
            const payload = getPayloadForGoogleChat();
            const jsonPayload = JSON.stringify(payload, null, 2);
            
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = jsonPayload;
            tempTextarea.style.position = 'fixed';
            tempTextarea.style.top = '0';
            tempTextarea.style.left = '0';
            tempTextarea.style.opacity = '0';
            document.body.appendChild(tempTextarea);
            tempTextarea.focus();
            tempTextarea.select();
            
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);
            displayMessage('× ×ª×•× ×™ ×”-JSON ×”×•×¢×ª×§×• ×œ×œ×•×—!', 'success');
        } catch (err) {
            console.error('Failed to copy text: ', err);
            displayMessage('×”×¢×ª×§×” × ×›×©×œ×”. ×‘×“×•×§ ×©×”×›×•×ª×¨×ª ××•×œ××”.', 'error');
        }
    }
    
    // --- Scheduling functions (Same logic as v3, now using better inputs) ---
    window.startCustomAutoSend = function() { /* ... implementation ... */ 
        if (autoSendIntervalId) {
            displayMessage('×”×©×œ×™×—×” ×”××•×˜×•××˜×™×ª ×›×‘×¨ ×¤×¢×™×œ×”.', 'info');
            return;
        }
        const intervalAmount = parseInt(document.getElementById('intervalAmount').value, 10);
        const intervalUnit = document.getElementById('intervalUnit').value;

        if (isNaN(intervalAmount) || intervalAmount <= 0) {
            displayMessage('×× × ×”×–×Ÿ ××¡×¤×¨ ×ª×§×™×Ÿ.', 'error');
            return;
        }

        let ms;
        switch (intervalUnit) {
            case 'minutes': ms = intervalAmount * 60 * 1000; break;
            case 'hours': ms = intervalAmount * 3600 * 1000; break;
            case 'days': ms = intervalAmount * 24 * 3600 * 1000; break;
            default: displayMessage('×™×—×™×“×ª ×–××Ÿ ×œ× ×—×•×§×™×ª.', 'error'); return;
        }
        
        statusBox.textContent = `×©×œ×™×—×” ××•×˜×•××˜×™×ª ××•×¤×¢×œ×ª, ×”×•×“×¢×” ×ª×™×©×œ×— ×›×œ ${intervalAmount} ${intervalUnit}.`;
        displayMessage(`×©×œ×™×—×” ××•×˜×•××˜×™×ª ××•×¤×¢×œ×ª!`, 'success');
        
        sendCard();
        autoSendIntervalId = setInterval(() => { sendCard(); }, ms);
    }
    
    window.stopCustomAutoSend = function() { /* ... implementation ... */ 
        if (autoSendIntervalId) {
            clearInterval(autoSendIntervalId);
            autoSendIntervalId = null;
            statusBox.textContent = '×”×©×œ×™×—×” ×”××•×˜×•××˜×™×ª ×”×•×¤×¡×§×”.';
            displayMessage('×”×©×œ×™×—×” ×”××•×˜×•××˜×™×ª ×”×•×¤×¡×§×”.', 'info');
        } else {
            displayMessage('××™×Ÿ ×©×œ×™×—×” ××•×˜×•××˜×™×ª ×¤×¢×™×œ×”.', 'info');
        }
    }

    window.scheduleSendAtDateTime = function() { /* ... implementation ... */ 
        if (scheduledTimeoutId) {
            clearTimeout(scheduledTimeoutId);
            scheduledTimeoutId = null;
            displayMessage('×ª×–××•×Ÿ ×§×•×“× ×‘×•×˜×œ.', 'info');
        }
        
        if (autoSendIntervalId) {
            clearInterval(autoSendIntervalId);
            autoSendIntervalId = null;
            displayMessage('×©×œ×™×—×” ××•×˜×•××˜×™×ª ×§×‘×•×¢×” ×‘×•×˜×œ×” ×œ×˜×•×‘×ª ×”×ª×–××•×Ÿ ×”×—×“ ×¤×¢××™.', 'info');
        }

        const scheduledDateTime = document.getElementById('scheduledDateTime').value;
        if (!scheduledDateTime) {
            displayMessage('×× × ×‘×—×¨ ×ª××¨×™×š ×•×©×¢×” ×œ×ª×–××•×Ÿ.', 'error');
            return;
        }

        const scheduledDate = new Date(scheduledDateTime);
        const now = new Date();
        const delayMs = scheduledDate.getTime() - now.getTime();

        if (delayMs <= 0) {
            displayMessage('×”×ª××¨×™×š ×•×”×©×¢×” ×—×™×™×‘×™× ×œ×”×™×•×ª ×‘×¢×ª×™×“.', 'error');
            return;
        }

        statusBox.textContent = `×”×•×“×¢×” ×ª×©×œ×— ×‘×ª××¨×™×š: ${scheduledDate.toLocaleString()}.`;
        displayMessage(`×”×•×“×¢×” ×ª×©×œ×— ×›××ª×•×›× ×Ÿ.`, 'success');
        
        scheduledTimeoutId = setTimeout(() => {
            try {
                sendCard();
                document.getElementById('statusBox').textContent = '×”×©×œ×™×—×” ×”××ª×•×–×× ×ª ×”×¡×ª×™×™××”.';
            } catch (e) {
                 document.getElementById('statusBox').textContent = '×©×’×™××” ×‘×©×œ×™×—×” ×”××ª×•×–×× ×ª.';
            } finally {
                scheduledTimeoutId = null;
            }
        }, delayMs);
    }

    /* ======= PREVIEW & UPDATE LOGIC (Main Function) ======= */
    function updatePreview() {
        // --- 1. Header Image ---
        const headerImgUrl = headerImageUrlInput.value.trim();
        if (headerImgUrl) {
            previewHeaderImage.src = headerImgUrl;
            previewHeaderImage.classList.remove('hidden');
        } else {
            previewHeaderImage.src = '';
            previewHeaderImage.classList.add('hidden');
        }
        
        // --- 2. Main Text Content ---
        // Contenteditable elements update themselves, no need to set innerHTML here
        
        // --- 3. Image in Body ---
        const imgUrl = imageUrlInput.value.trim();
        if (imgUrl) {
            previewImage.src = imgUrl;
            previewImage.classList.remove('hidden');
        } else {
            previewImage.src = '';
            previewImage.classList.add('hidden');
        }

        // --- 4. Button in Body ---
        const buttonText = buttonTextInput.value.trim();
        const buttonUrl = buttonUrlInput.value.trim();
        let buttonHtml = '';
        if (buttonText && buttonUrl) {
            buttonHtml = `<a href="${buttonUrl}" target="_blank" style="background-color: #3b82f6; color: white; font-weight: bold; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-block; transition: background-color 0.2s;">
                            ${buttonText}
                          </a>`;
            previewButton.classList.remove('hidden');
        } else {
            previewButton.classList.add('hidden');
        }
        previewButton.innerHTML = buttonHtml;
    }


    /* ======= Initialization ======= */
    window.onload = function() {
        loadWebhooksFromLocalStorage();
        updatePreview();
        
        // Set initial content for inline editors from virtual inputs (for placeholder logic to work)
        previewSenderName.textContent = virtualInputs.senderNameInput;
        previewTitle.textContent = virtualInputs.cardTitleInput;
        
        // Add event listeners for non-inline inputs
        headerImageUrlInput.addEventListener('input', updatePreview);
        imageUrlInput.addEventListener('input', updatePreview);
        buttonTextInput.addEventListener('input', updatePreview);
        buttonUrlInput.addEventListener('input', updatePreview);
    };
</script>
</body>
</html>
